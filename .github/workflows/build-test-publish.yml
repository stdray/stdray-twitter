name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for GitVersion to work properly

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install Cake
      run: |
        dotnet tool install -g Cake.Tool
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v3.0.0
      with:
        versionSpec: '5.x'

    # Run tests on all PRs and main branch
    - name: Run Tests
      run: |
        dotnet-cake --target="Default" --configuration="Release"
      if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    # Only run publishing on main branch (after tests pass)
    - name: Publish to NuGet (on main branch)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        dotnet-cake --target="CI" --configuration="Release"
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    # Upload artifacts
    - name: Upload artifacts
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./artifacts/*.nupkg