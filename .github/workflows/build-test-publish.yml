name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Ensure build script is executable
        run: chmod +x ./build.sh

      - name: Run Cake tests
        run: ./build.sh --target=Test --configuration=Release

  publish:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Ensure build script is executable
        run: chmod +x ./build.sh

      - name: Publish NuGet package
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: ./build.sh --target=NuGetPush --configuration=Release

      - name: Upload NuGet artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: artifacts/*.nupkg